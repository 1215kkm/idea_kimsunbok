<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë‹¤ëœë“œ ë§ˆì„ ì‹œë®¬ë ˆì´ì…˜</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Segoe UI',sans-serif;background:#0a0a2e;color:#fff;overflow:hidden;height:100vh;width:100vw;}

/* ===== ì¸íŠ¸ë¡œ ===== */
#intro{position:fixed;inset:0;z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;
background:linear-gradient(135deg,#0a0a2e 0%,#1a1a4e 50%,#0a0a2e 100%);transition:opacity 0.8s;}
#intro.hide{opacity:0;pointer-events:none;}
.intro-sub{font-size:0.9rem;color:#666;letter-spacing:3px;margin-bottom:8px;}
.intro-title{font-size:3.2rem;font-weight:900;
background:linear-gradient(90deg,#00d4ff,#7b2ff7,#ff6b6b);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.intro-desc{font-size:0.95rem;color:#888;margin-bottom:30px;text-align:center;line-height:1.6;padding:0 20px;}

/* ìºë¦­í„° ì†Œê°œ ì¹´ë“œ */
.char-cards{display:flex;gap:10px;margin-bottom:30px;padding:0 15px;flex-wrap:wrap;justify-content:center;}
.char-card{background:rgba(20,20,60,0.8);border:1px solid rgba(123,47,247,0.2);border-radius:14px;
padding:12px;text-align:center;min-width:80px;flex:1;max-width:100px;}
.char-card .cc-emoji{font-size:2rem;}
.char-card .cc-name{font-size:0.75rem;font-weight:700;margin-top:4px;color:#ddd;}
.char-card .cc-role{font-size:0.6rem;color:#7b2ff7;margin-top:2px;}

.btn-start{padding:16px 50px;font-size:1.1rem;font-weight:700;
background:linear-gradient(135deg,#7b2ff7,#00d4ff);border:none;border-radius:50px;color:#fff;
cursor:pointer;box-shadow:0 0 30px rgba(123,47,247,0.4);transition:transform 0.2s;}
.btn-start:active{transform:scale(0.95);}

/* ===== ë©”ì¸ í™”ë©´ ===== */
#main{display:none;height:100vh;flex-direction:column;}
#main.on{display:flex;}

/* ìƒë‹¨ ìŠ¤íƒ¯ë°” */
.stat-bar{display:flex;gap:4px;padding:8px 10px;background:#050520;
border-bottom:1px solid rgba(123,47,247,0.3);flex-shrink:0;overflow-x:auto;}
.stat-char{display:flex;align-items:center;gap:6px;background:rgba(20,20,50,0.9);
border-radius:12px;padding:6px 10px;min-width:0;flex:1;}
.stat-char .sc-emoji{font-size:1.3rem;flex-shrink:0;}
.stat-char .sc-info{min-width:0;}
.stat-char .sc-name{font-size:0.65rem;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.stat-char .sc-pts{font-size:0.95rem;font-weight:900;color:#00d4ff;white-space:nowrap;}
.stat-char.active{border:1px solid #7b2ff7;background:rgba(123,47,247,0.2);}

/* ë§ˆì„ ë§µ */
.town-wrap{flex:1;position:relative;overflow:hidden;min-height:0;}
.town-map{position:relative;width:100%;height:100%;
background:linear-gradient(180deg,#0a1a06 0%,#122a0e 40%,#0a2008 100%);}

/* ë„ë¡œ */
.road{position:absolute;background:repeating-linear-gradient(90deg,#2a2a3a 0px,#2a2a3a 8px,#353545 8px,#353545 10px);}
.road-h{height:6%;left:0;right:0;}
.road-v{width:6%;top:0;bottom:0;}
.road-h.r1{top:30%;}
.road-h.r2{top:65%;}
.road-v.r1{left:33%;}
.road-v.r2{left:66%;}

/* ê±´ë¬¼ */
.bld{position:absolute;text-align:center;cursor:pointer;transition:transform 0.3s,box-shadow 0.3s;z-index:5;}
.bld-body{border-radius:8px 8px 2px 2px;padding:6px 4px;position:relative;
box-shadow:0 4px 12px rgba(0,0,0,0.4),inset 0 -2px 4px rgba(0,0,0,0.2);}
.bld .bld-icon{font-size:1.8rem;display:block;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.3));}
.bld .bld-name{font-size:0.65rem;font-weight:700;color:#fff;margin-top:2px;
text-shadow:0 1px 3px rgba(0,0,0,0.7);white-space:nowrap;}
.bld .bld-price{font-size:0.65rem;font-weight:700;color:#ffcc00;text-shadow:0 1px 3px rgba(0,0,0,0.7);}
.bld:active{transform:scale(0.92);}
.bld.glow .bld-body{box-shadow:0 0 20px rgba(123,47,247,0.6),0 4px 12px rgba(0,0,0,0.4);}
.bld.visited{opacity:0.4;pointer-events:none;}

/* ê±´ë¬¼ ì§€ë¶• 3D íš¨ê³¼ */
.bld-body::before{content:'';position:absolute;top:-6px;left:-3px;right:-3px;height:8px;
border-radius:4px 4px 0 0;background:inherit;filter:brightness(1.3);}

/* ìºë¦­í„° (ë§ˆì„ ìœ„) */
.char{position:absolute;z-index:10;display:flex;flex-direction:column;align-items:center;
transition:left 1.2s cubic-bezier(0.25,0.46,0.45,0.94),top 1.2s cubic-bezier(0.25,0.46,0.45,0.94);}
.char-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
font-size:1.3rem;border:2px solid;box-shadow:0 3px 8px rgba(0,0,0,0.4);position:relative;}
.char-avatar::after{content:'';position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);
width:24px;height:6px;background:rgba(0,0,0,0.25);border-radius:50%;filter:blur(2px);}
.char-label{font-size:0.5rem;font-weight:700;margin-top:2px;padding:1px 5px;border-radius:6px;
background:rgba(0,0,0,0.6);white-space:nowrap;text-shadow:0 1px 1px rgba(0,0,0,0.5);}

/* ìºë¦­í„° ìƒ‰ìƒ */
.char-younghee .char-avatar{background:linear-gradient(135deg,#ff6b9d,#c44dff);border-color:#ff8fbf;}
.char-chulsu .char-avatar{background:linear-gradient(135deg,#ff8c42,#e6553a);border-color:#ffaa66;}
.char-jieun .char-avatar{background:linear-gradient(135deg,#4dabf7,#3b5bdb);border-color:#74c0fc;}

/* ë§í’ì„  */
.speech{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,0.8);border:1px solid rgba(123,47,247,0.3);border-radius:10px;
padding:5px 10px;font-size:0.6rem;white-space:nowrap;opacity:0;transition:opacity 0.3s;
pointer-events:none;margin-bottom:6px;}
.speech::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);
border:4px solid transparent;border-top-color:rgba(0,0,0,0.8);}
.speech.on{opacity:1;}

/* ===== í•˜ë‹¨ ìŠ¤í† ë¦¬ íŒ¨ë„ ===== */
.story-panel{flex-shrink:0;background:linear-gradient(0deg,#0a0a2e,#0d0d35);
border-top:1px solid rgba(123,47,247,0.2);padding:12px 16px;min-height:120px;max-height:35vh;
display:flex;flex-direction:column;}
.story-speaker{font-size:0.7rem;color:#7b2ff7;font-weight:700;letter-spacing:1px;margin-bottom:4px;}
.story-text{font-size:0.82rem;line-height:1.6;color:#ccc;flex:1;overflow-y:auto;}
.story-text em{color:#00d4ff;font-style:normal;font-weight:600;}
.story-text b{color:#ff6b6b;}
.story-btn{margin-top:8px;padding:10px;font-size:0.85rem;font-weight:700;
background:linear-gradient(135deg,#7b2ff7,#00d4ff);border:none;border-radius:12px;
color:#fff;cursor:pointer;transition:transform 0.2s;align-self:stretch;text-align:center;}
.story-btn:active{transform:scale(0.95);}
.story-btn:disabled{opacity:0.3;pointer-events:none;}

/* ===== ì—°ì‡„íš¨ê³¼ ì˜¤ë²„ë ˆì´ ===== */
.chain-overlay{position:absolute;inset:0;z-index:50;pointer-events:none;}

/* í¬ì¸íŠ¸ í”Œë¡œíŒ… í…ìŠ¤íŠ¸ */
.float-text{position:absolute;font-weight:900;font-size:1.4rem;
animation:floatUp 4s ease-out forwards;pointer-events:none;z-index:60;
text-shadow:0 2px 8px rgba(0,0,0,0.8),0 0 20px rgba(0,0,0,0.5);
background:rgba(0,0,0,0.6);padding:4px 10px;border-radius:8px;}
.float-text.positive{color:#00ff88;}
.float-text.negative{color:#ff6b6b;}
.float-text.bonus{color:#ffcc00;font-size:1.6rem;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}
70%{opacity:1;transform:translateY(-40px) scale(1);}
100%{opacity:0;transform:translateY(-70px) scale(0.8);}}

/* íë¦„ í™”ì‚´í‘œ (ì ì„ ) */
.flow-line{position:absolute;z-index:55;pointer-events:none;}

/* íŒŒí‹°í´ */
.particle{position:absolute;pointer-events:none;z-index:70;font-size:1rem;
animation:particleFly 1.5s ease-out forwards;}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1);}
100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0.3);}}

/* ì—°ê²°ì„  SVG */
.flow-svg{position:absolute;inset:0;z-index:45;pointer-events:none;}
.flow-path{fill:none;stroke-width:2;stroke-dasharray:6 4;
animation:dashFlow 0.8s linear infinite;}
@keyframes dashFlow{to{stroke-dashoffset:-20;}}

/* í¬ì¸íŠ¸ ì´ë™ ì  */
.flow-dot{fill:#00d4ff;animation:pulseDot 0.5s ease-in-out infinite alternate;}
@keyframes pulseDot{from{r:3;opacity:0.6;}to{r:5;opacity:1;}}

/* ===== ê²°ê³¼ ëª¨ë‹¬ ===== */
.result-modal{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;
background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);padding:20px;}
.result-modal.on{display:flex;}
.result-card{background:linear-gradient(135deg,#1a1a4e,#0d0d30);border:1px solid rgba(123,47,247,0.4);
border-radius:20px;padding:25px 20px;text-align:center;width:100%;max-width:360px;max-height:80vh;overflow-y:auto;}
.rc-icon{font-size:3.5rem;}
.rc-title{font-size:1.3rem;font-weight:900;margin-top:6px;}
.rc-subtitle{font-size:0.8rem;color:#888;margin-bottom:12px;}

/* ê³µì‹ ë‹¨ê³„ í‘œì‹œ */
.formula-step{background:rgba(123,47,247,0.08);border:1px solid rgba(123,47,247,0.15);
border-radius:10px;padding:8px 12px;margin:6px 0;font-size:0.75rem;text-align:left;
color:#bbb;opacity:0;transform:translateX(-10px);transition:all 0.5s;}
.formula-step.show{opacity:1;transform:translateX(0);}
.formula-step .fs-label{color:#7b2ff7;font-weight:700;font-size:0.65rem;margin-bottom:2px;}
.formula-step .fs-value{color:#fff;font-weight:600;}
.formula-step .fs-value .hl{color:#00ff88;font-size:0.9rem;}
.formula-step .fs-value .hl-red{color:#ff6b6b;}
.formula-step .fs-value .hl-yellow{color:#ffcc00;}

/* í° ê²°ê³¼ */
.rc-big{font-size:3.5rem;font-weight:900;margin:15px 0 5px;
background:linear-gradient(90deg,#00ff88,#00d4ff);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
opacity:0;transform:scale(0.5);transition:all 0.6s cubic-bezier(0.17,0.89,0.32,1.28);}
.rc-big.show{opacity:1;transform:scale(1);}
.rc-badge{display:inline-block;background:linear-gradient(135deg,#ff6b6b,#ff8e53);
padding:5px 18px;border-radius:30px;font-size:1.1rem;font-weight:900;
opacity:0;transform:scale(0);transition:all 0.5s cubic-bezier(0.17,0.89,0.32,1.28);}
.rc-badge.show{opacity:1;transform:scale(1);}

/* ì—°ì‡„íš¨ê³¼ ì¹´ë“œ */
.chain-cards{display:flex;flex-direction:column;gap:6px;margin-top:12px;}
.chain-card{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.04);
border-radius:10px;padding:8px 10px;opacity:0;transform:translateY(8px);transition:all 0.4s;}
.chain-card.show{opacity:1;transform:translateY(0);}
.chain-card .cci{font-size:1.3rem;flex-shrink:0;}
.chain-card .cctext{text-align:left;font-size:0.7rem;color:#ccc;flex:1;}
.chain-card .cctext b{color:#00ff88;}
.chain-card .cctext .sub{color:#888;font-size:0.6rem;}
.chain-card .ccpts{font-weight:900;color:#00d4ff;font-size:0.85rem;flex-shrink:0;}

.rc-btn{margin-top:15px;padding:12px 30px;font-size:0.9rem;font-weight:700;
background:rgba(123,47,247,0.25);border:1px solid #7b2ff7;border-radius:30px;
color:#fff;cursor:pointer;transition:transform 0.2s;}
.rc-btn:active{transform:scale(0.95);}

/* ===== ìƒíƒœê³„ ì˜¤ë²„ë ˆì´ ===== */
.eco-overlay{position:fixed;inset:0;z-index:300;display:none;flex-direction:column;
align-items:center;background:linear-gradient(135deg,#0a0a2e,#1a1a4e);
padding:20px;text-align:center;overflow-y:auto;justify-content:safe center;}
.eco-overlay.on{display:flex;}
.eco-title{font-size:2rem;font-weight:900;margin-bottom:5px;
background:linear-gradient(90deg,#00d4ff,#7b2ff7,#ff6b6b);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.eco-sub{font-size:0.85rem;color:#888;margin-bottom:20px;}

/* ìˆœí™˜ ë‹¤ì´ì–´ê·¸ë¨ */
.cycle-ring{position:relative;width:280px;height:280px;margin:0 auto;}
.cycle-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#7b2ff7,#00d4ff);
display:flex;align-items:center;justify-content:center;flex-direction:column;
box-shadow:0 0 30px rgba(123,47,247,0.4);z-index:2;}
.cycle-center .cc-label{font-size:0.55rem;color:rgba(255,255,255,0.7);}
.cycle-center .cc-val{font-size:0.85rem;font-weight:900;}
.cycle-node{position:absolute;width:60px;height:60px;border-radius:50%;
display:flex;align-items:center;justify-content:center;flex-direction:column;
border:2px solid;box-shadow:0 0 15px rgba(0,0,0,0.3);z-index:2;}
.cycle-node .cn-emoji{font-size:1.3rem;}
.cycle-node .cn-name{font-size:0.45rem;font-weight:700;margin-top:1px;}
.cycle-node .cn-pts{font-size:0.5rem;color:#00ff88;font-weight:700;}

/* ìˆœí™˜ í™”ì‚´í‘œ */
.cycle-svg{position:absolute;inset:0;z-index:1;}
.cycle-arrow{fill:none;stroke-width:2;stroke-dasharray:5 3;opacity:0.6;
animation:dashFlow 1s linear infinite;}

/* ì´í•© ì¹´ë“œ */
.eco-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:15px;width:100%;max-width:340px;}
.eco-stat{background:rgba(25,25,65,0.8);border:1px solid rgba(123,47,247,0.2);
border-radius:12px;padding:12px;text-align:center;}
.eco-stat .es-label{font-size:0.65rem;color:#777;}
.eco-stat .es-val{font-size:1.3rem;font-weight:900;margin-top:3px;}
.eco-stat .es-val.c1{color:#ff6b6b;}
.eco-stat .es-val.c2{color:#00ff88;}
.eco-stat .es-val.c3{color:#00d4ff;}
.eco-stat .es-val.c4{color:#7b2ff7;}

.eco-quote{font-size:0.9rem;color:#999;margin-top:15px;line-height:1.6;max-width:340px;font-style:italic;}
.eco-quote b{color:#7b2ff7;font-style:normal;}

.btn-restart{margin-top:15px;padding:14px 40px;font-size:1rem;font-weight:700;
background:linear-gradient(135deg,#7b2ff7,#00d4ff);border:none;border-radius:50px;color:#fff;cursor:pointer;}
.btn-restart:active{transform:scale(0.95);}

/* ===== ìœ í‹¸ë¦¬í‹° ===== */
.hidden{display:none!important;}

/* ê±·ê¸° ì• ë‹ˆë©”ì´ì…˜ */
.walking .char-avatar{animation:walk 0.4s ease-in-out infinite alternate;}
@keyframes walk{from{transform:translateY(0);}to{transform:translateY(-3px);}}

/* ë¹›ë‚˜ê¸° */
@keyframes glow{0%,100%{box-shadow:0 0 5px rgba(123,47,247,0.3);}50%{box-shadow:0 0 20px rgba(123,47,247,0.6);}}
.glowing{animation:glow 1s ease-in-out infinite;}

/* ìŠ¤í¬ë¡¤ë°” */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#7b2ff744;border-radius:3px;}
</style>
</head>
<body>

<!-- ===== ì¸íŠ¸ë¡œ ===== -->
<div id="intro">
  <div class="intro-sub">ë¹„ì„ í˜•ê³µì‹ ì²´í—˜ ì‹œë®¬ë ˆì´ì…˜</div>
  <div class="intro-title">ë‹¤ëœë“œ ë§ˆì„</div>
  <div class="intro-desc">
    ì†Œë¹„ê°€ ë§Œë“œëŠ” ì„ ìˆœí™˜ ê²½ì œ<br>
    í•œ ì‚¬ëŒì˜ ì†Œë¹„ê°€ ëª¨ë‘ì—ê²Œ<br>ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ì§€ ì²´í—˜í•˜ì„¸ìš”
  </div>
  <div class="char-cards">
    <div class="char-card">
      <div class="cc-emoji">ğŸ‘©</div>
      <div class="cc-name">ë°•ì˜í¬</div>
      <div class="cc-role">ì†Œë¹„ì (28ì„¸)</div>
    </div>
    <div class="char-card">
      <div class="cc-emoji">ğŸ‘¨â€ğŸ³</div>
      <div class="cc-name">ê¹€ì² ìˆ˜</div>
      <div class="cc-role">ì¹´í˜ì‚¬ì¥ (45ì„¸)</div>
    </div>
    <div class="char-card">
      <div class="cc-emoji">ğŸ‘©â€ğŸ’¼</div>
      <div class="cc-name">ì´ì§€ì€</div>
      <div class="cc-role">ì˜í¬ ë™ë£Œ</div>
    </div>
  </div>
  <button class="btn-start" onclick="startGame()">ë§ˆì„ ì…ì¥í•˜ê¸°</button>
</div>

<!-- ===== ë©”ì¸ í™”ë©´ ===== -->
<div id="main">
  <!-- ìƒë‹¨ ìºë¦­í„° ìŠ¤íƒ¯ -->
  <div class="stat-bar">
    <div class="stat-char active" id="stat-younghee">
      <span class="sc-emoji">ğŸ‘©</span>
      <div class="sc-info"><div class="sc-name">ë°•ì˜í¬</div><div class="sc-pts" id="sp-younghee">0P</div></div>
    </div>
    <div class="stat-char" id="stat-chulsu">
      <span class="sc-emoji">ğŸ‘¨â€ğŸ³</span>
      <div class="sc-info"><div class="sc-name">ê¹€ì² ìˆ˜</div><div class="sc-pts" id="sp-chulsu">0P</div></div>
    </div>
    <div class="stat-char" id="stat-jieun">
      <span class="sc-emoji">ğŸ‘©â€ğŸ’¼</span>
      <div class="sc-info"><div class="sc-name">ì´ì§€ì€</div><div class="sc-pts" id="sp-jieun">0P</div></div>
    </div>
  </div>

  <!-- ë§ˆì„ ë§µ -->
  <div class="town-wrap">
    <div class="town-map" id="townMap">
      <!-- ë„ë¡œ -->
      <div class="road road-h r1"></div>
      <div class="road road-h r2"></div>
      <div class="road road-v r1"></div>
      <div class="road road-v r2"></div>

      <!-- ê±´ë¬¼ë“¤ (JSì—ì„œ ìœ„ì¹˜ ì„¸íŒ…) -->
      <div class="bld" id="bld-cafe" style="left:5%;top:5%;">
        <div class="bld-body" style="background:linear-gradient(180deg,#8B4513,#D2691E);">
          <span class="bld-icon">â˜•</span>
          <div class="bld-name">í–‰ë³µí•œ ì¹´í˜</div>
          <div class="bld-price">ì»¤í”¼ 4,000ì›</div>
        </div>
      </div>
      <div class="bld" id="bld-super" style="left:38%;top:5%;">
        <div class="bld-body" style="background:linear-gradient(180deg,#2E8B57,#3CB371);">
          <span class="bld-icon">ğŸª</span>
          <div class="bld-name">í–‰ë³µí•œ ìŠˆí¼</div>
          <div class="bld-price">ì¥ë³´ê¸° 30,000ì›</div>
        </div>
      </div>
      <div class="bld" id="bld-gas" style="left:72%;top:5%;">
        <div class="bld-body" style="background:linear-gradient(180deg,#4169E1,#6495ED);">
          <span class="bld-icon">â›½</span>
          <div class="bld-name">ì£¼ìœ ì†Œ</div>
          <div class="bld-price">ì£¼ìœ  70,000ì›</div>
        </div>
      </div>
      <div class="bld" id="bld-pharm" style="left:5%;top:42%;">
        <div class="bld-body" style="background:linear-gradient(180deg,#9370DB,#BA55D3);">
          <span class="bld-icon">ğŸ’Š</span>
          <div class="bld-name">ê±´ê°• ì•½êµ­</div>
          <div class="bld-price">ë¹„íƒ€ë¯¼ 8,000ì›</div>
        </div>
      </div>
      <div class="bld" id="bld-ad" style="left:38%;top:42%;">
        <div class="bld-body" style="background:linear-gradient(180deg,#DAA520,#FFD700);">
          <span class="bld-icon">ğŸ“º</span>
          <div class="bld-name">ê·¸ëƒ¥ë“œë¦¼</div>
          <div class="bld-price">ê´‘ê³ ì‹œì²­ ë³´ìƒ</div>
        </div>
      </div>
      <div class="bld" id="bld-rest" style="left:72%;top:42%;">
        <div class="bld-body" style="background:linear-gradient(180deg,#CD853F,#DEB887);">
          <span class="bld-icon">ğŸ½ï¸</span>
          <div class="bld-name">ë§›ìˆëŠ” ì‹ë‹¹</div>
          <div class="bld-price">ì™¸ì‹ 25,000ì›</div>
        </div>
      </div>

      <!-- ë§ˆì„ ì¥ì‹ -->
      <div style="position:absolute;left:28%;top:37%;font-size:1.2rem;opacity:0.5;z-index:1;">ğŸŒ³</div>
      <div style="position:absolute;left:62%;top:37%;font-size:1rem;opacity:0.4;z-index:1;">ğŸŒ²</div>
      <div style="position:absolute;left:90%;top:60%;font-size:1rem;opacity:0.4;z-index:1;">ğŸŒ³</div>
      <div style="position:absolute;left:2%;top:62%;font-size:0.9rem;opacity:0.3;z-index:1;">ğŸŒ¿</div>
      <div style="position:absolute;left:50%;top:80%;font-size:0.8rem;opacity:0.3;z-index:1;">ğŸŒ¸</div>
      <div style="position:absolute;left:85%;top:18%;font-size:0.8rem;opacity:0.3;z-index:1;">ğŸŒ¿</div>
      <div style="position:absolute;right:8px;top:4px;font-size:0.45rem;color:rgba(255,255,255,0.2);z-index:1;letter-spacing:1px;">ë‹¤ëœë“œ ë§ˆì„</div>

      <!-- ì‹œìŠ¤í…œ í’€ í‘œì‹œ -->
      <div id="poolIndicator" style="position:absolute;bottom:4%;left:50%;transform:translateX(-50%);
        background:rgba(123,47,247,0.2);border:1px solid rgba(123,47,247,0.3);border-radius:10px;
        padding:4px 12px;font-size:0.6rem;color:#7b2ff7;text-align:center;z-index:8;">
        <div style="font-size:0.5rem;color:#666;">ë©¤ë²„ì‹­ í’€</div>
        <div id="poolAmount" style="font-weight:700;">0P</div>
      </div>

      <!-- ìºë¦­í„°ë“¤ -->
      <div class="char char-younghee" id="char-younghee" style="left:15%;top:72%;">
        <div class="speech" id="speech-younghee"></div>
        <div class="char-avatar">ğŸ‘©</div>
        <div class="char-label">ì˜í¬</div>
      </div>
      <div class="char char-chulsu" id="char-chulsu" style="left:12%;top:18%;">
        <div class="speech" id="speech-chulsu"></div>
        <div class="char-avatar">ğŸ‘¨â€ğŸ³</div>
        <div class="char-label">ê¹€ì² ìˆ˜</div>
      </div>
      <div class="char char-jieun" id="char-jieun" style="left:55%;top:72%;">
        <div class="speech" id="speech-jieun"></div>
        <div class="char-avatar">ğŸ‘©â€ğŸ’¼</div>
        <div class="char-label">ì´ì§€ì€</div>
      </div>

      <!-- ì—°ì‡„íš¨ê³¼ ì˜¤ë²„ë ˆì´ (SVG + íŒŒí‹°í´) -->
      <div class="chain-overlay" id="chainOverlay">
        <svg class="flow-svg" id="flowSvg"></svg>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ìŠ¤í† ë¦¬ -->
  <div class="story-panel">
    <div class="story-speaker" id="storySpeaker">ë‚´ë ˆì´í„°</div>
    <div class="story-text" id="storyText">ë‹¤ëœë“œ ë§ˆì„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</div>
    <button class="story-btn" id="storyBtn" onclick="nextStep()">ì‹œì‘ â†’</button>
  </div>
</div>

<!-- ===== ê²°ê³¼ ëª¨ë‹¬ ===== -->
<div class="result-modal" id="resultModal">
  <div class="result-card" id="resultCard"></div>
</div>

<!-- ===== ìƒíƒœê³„ ì—”ë”© ===== -->
<div class="eco-overlay" id="ecoOverlay">
  <div class="eco-title">ì„ ìˆœí™˜ ê²½ì œ ì™„ì„±!</div>
  <div class="eco-sub">ë‹¤ëœë“œ ë§ˆì„ì˜ í•˜ë£¨ê°€ ë§Œë“  ë³€í™”</div>

  <div class="cycle-ring" id="cycleRing">
    <svg class="cycle-svg" viewBox="0 0 280 280">
      <defs>
        <marker id="arrow-pink" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#ff6b9d"/>
        </marker>
        <marker id="arrow-orange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#ff8c42"/>
        </marker>
        <marker id="arrow-blue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#4dabf7"/>
        </marker>
      </defs>
      <circle cx="140" cy="140" r="110" fill="none" stroke="rgba(123,47,247,0.15)" stroke-width="1"/>
      <!-- ì˜í¬(top) â†’ ê¹€ì² ìˆ˜(bottom-right) -->
      <path class="cycle-arrow" d="M170,38 A110,110 0 0,1 232,188" stroke="#ff6b9d" marker-end="url(#arrow-pink)"/>
      <!-- ê¹€ì² ìˆ˜(bottom-right) â†’ ì´ì§€ì€(bottom-left) -->
      <path class="cycle-arrow" d="M205,225 A110,110 0 0,1 75,225" stroke="#ff8c42" marker-end="url(#arrow-orange)" style="animation-delay:0.3s"/>
      <!-- ì´ì§€ì€(bottom-left) â†’ ì˜í¬(top) -->
      <path class="cycle-arrow" d="M48,188 A110,110 0 0,1 110,38" stroke="#4dabf7" marker-end="url(#arrow-blue)" style="animation-delay:0.6s"/>
    </svg>
    <div class="cycle-center">
      <div class="cc-label">ë¹„ì„ í˜•ê³µì‹</div>
      <div class="cc-val">120%</div>
    </div>
    <!-- ì˜í¬: top center -->
    <div class="cycle-node" id="cn-younghee" style="left:calc(50% - 30px);top:-10px;
      background:linear-gradient(135deg,#ff6b9d,#c44dff);border-color:#ff8fbf;">
      <span class="cn-emoji">ğŸ‘©</span>
      <span class="cn-name">ì˜í¬</span>
      <span class="cn-pts" id="cn-pts-y">0P</span>
    </div>
    <!-- ê¹€ì² ìˆ˜: bottom-right -->
    <div class="cycle-node" id="cn-chulsu" style="right:-5px;bottom:15px;
      background:linear-gradient(135deg,#ff8c42,#e6553a);border-color:#ffaa66;">
      <span class="cn-emoji">ğŸ‘¨â€ğŸ³</span>
      <span class="cn-name">ê¹€ì² ìˆ˜</span>
      <span class="cn-pts" id="cn-pts-c">0P</span>
    </div>
    <!-- ì´ì§€ì€: bottom-left -->
    <div class="cycle-node" id="cn-jieun" style="left:-5px;bottom:15px;
      background:linear-gradient(135deg,#4dabf7,#3b5bdb);border-color:#74c0fc;">
      <span class="cn-emoji">ğŸ‘©â€ğŸ’¼</span>
      <span class="cn-name">ì´ì§€ì€</span>
      <span class="cn-pts" id="cn-pts-j">0P</span>
    </div>
  </div>

  <div class="eco-stats" id="ecoStats"></div>

  <div class="eco-quote">
    "í•œ ì‚¬ëŒì˜ ì†Œë¹„ê°€ ì‚¬ë¼ì§€ì§€ ì•Šê³ ,<br>
    ë§ˆì„ ì „ì²´ë¥¼ ìˆœí™˜í•˜ë©° <b>ëª¨ë‘ì—ê²Œ ëŒì•„ì˜¨ë‹¤.</b>"<br><br>
    <span style="color:#7b2ff7;font-weight:700;">í•­ì•„ë¦¬ ì†ì˜ ë¬¼ ì´ëŸ‰ì€ ê°™ë‹¤ â€” ë°”ê°€ì§€ë§Œ ë°”ë€” ë¿.</span>
  </div>

  <button class="btn-restart" onclick="location.reload()">ë‹¤ì‹œ ì²´í—˜í•˜ê¸°</button>
</div>

<script>
/* ===== ìƒíƒœ ===== */
const STATE = {
  step: 0,
  chars: {
    younghee: { name:'ë°•ì˜í¬', emoji:'ğŸ‘©', pts:0, spent:0, earned:0 },
    chulsu:   { name:'ê¹€ì² ìˆ˜', emoji:'ğŸ‘¨â€ğŸ³', pts:0, spent:0, earned:0 },
    jieun:    { name:'ì´ì§€ì€', emoji:'ğŸ‘©â€ğŸ’¼', pts:0, spent:0, earned:0 },
  },
  pool: 0,
  totalSpent: 0,
  totalEarned: 0,
};

/* ===== ì‹œë‚˜ë¦¬ì˜¤ ì •ì˜ ===== */
const SCENARIO = [
  // Step 0: ì¸íŠ¸ë¡œ ë‚´ë ˆì´ì…˜
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'ì›”ìš”ì¼ ì•„ì¹¨, ë‹¤ëœë“œ ë§ˆì„.\n\n<em>ë°•ì˜í¬(28ì„¸)</em>ëŠ” ì¶œê·¼ê¸¸ì— í•œìˆ¨ì„ ì‰¬ì—ˆë‹¤.\n"ë§¤ì¼ ì“°ëŠ” ëˆì€ ê·¸ëƒ¥ ì‚¬ë¼ì§€ëŠ”ë°..."\n\në™ë£Œ <em>ì´ì§€ì€</em>ì´ ë§í–ˆë‹¤.\n"ë‹¤ëœë“œ ì¨ë´¤ì–´? ì“´ ëˆì˜ 120%ê°€ ëŒì•„ì˜¨ëŒ€."',
    btn:'ì˜í¬ì˜ ì²« ê²°ì œ â†’',
    setup(){ say('younghee','ëˆ ì“°ë©´ ì‚¬ë¼ì§€ê¸°ë§Œ í•˜ëŠ”ë°...'); say('jieun','ë‹¤ëœë“œ ì¨ë´¤ì–´?!'); }
  },
  // Step 1: ì˜í¬ â†’ ì¹´í˜
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'<em>ì˜í¬</em>ê°€ <em>í–‰ë³µí•œ ì¹´í˜</em>ë¡œ í–¥í•©ë‹ˆë‹¤.\nê¹€ì² ìˆ˜ ì‚¬ì¥ë‹˜ì˜ ê°€ê²Œì—ì„œ ì•„ë©”ë¦¬ì¹´ë…¸ í•œ ì”.',
    btn:null, // auto-advance after animation
    action:'younghee-cafe',
    setup(){ clearSpeech(); say('younghee','ì¹´í˜ ê°€ì•¼ì§€~'); moveTo('younghee','bld-cafe'); }
  },
  // Step 2: ì¹´í˜ ê²°ì œ ê²°ê³¼
  {
    speaker:'ë¹„ì„ í˜•ê³µì‹ ì—”ì§„',
    text:null,
    btn:null,
    action:'pay',
    pay:{ who:'younghee', store:'í–‰ë³µí•œ ì¹´í˜', storeIcon:'â˜•', storeOwner:'chulsu',
          amount:4000, item:'ì•„ë©”ë¦¬ì¹´ë…¸ í•œ ì”', bldId:'bld-cafe' }
  },
  // Step 3: ê¹€ì² ìˆ˜ì˜ ë°˜ì‘ + ìŠˆí¼ ì´ë™
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'ì¹´í˜ ì‚¬ì¥ <em>ê¹€ì² ìˆ˜</em>ëŠ” ì˜í¬ì˜ ê²°ì œ ë•ì— íŒë§¤ì í¬ì¸íŠ¸ê°€ ìŒ“ì˜€ë‹¤.\n\n"ì†ë‹˜ì´ ê²°ì œí•  ë•Œë§ˆë‹¤ ë‚˜í•œí…Œë„ í¬ì¸íŠ¸ê°€?!"\n\nê¹€ì² ìˆ˜ëŠ” ë°›ì€ í¬ì¸íŠ¸ì— ìš©ê¸°ë¥¼ ì–»ì–´ <em>ìŠˆí¼</em>ì—ì„œ ì‹ìì¬ë¥¼ êµ¬ë§¤í•˜ê¸°ë¡œ í–ˆë‹¤.',
    btn:null,
    action:'chulsu-super',
    setup(){ say('chulsu','ë‚˜ë„ ìŠˆí¼ì—ì„œ ì¥ë³´ì!'); moveTo('chulsu','bld-super'); }
  },
  // Step 4: ê¹€ì² ìˆ˜ ìŠˆí¼ ê²°ì œ
  {
    speaker:'ë¹„ì„ í˜•ê³µì‹ ì—”ì§„',
    text:null,
    btn:null,
    action:'pay',
    pay:{ who:'chulsu', store:'í–‰ë³µí•œ ìŠˆí¼', storeIcon:'ğŸª', storeOwner:null,
          amount:30000, item:'ì‹ìì¬ (ì‚¬ê³¼, ìš°ìœ , ê³ ê¸°)', bldId:'bld-super' }
  },
  // Step 5: ì´ì§€ì€ ê´‘ê³ ì‹œì²­
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'í•œí¸ <em>ì´ì§€ì€</em>ì€ ë‹¤ëœë“œ ì•±ì—ì„œ <em>ê·¸ëƒ¥ë“œë¦¼</em> ê´‘ê³ ë¥¼ ë°œê²¬í–ˆë‹¤.\n\n"15ì´ˆë§Œ ë³´ë©´ í¬ì¸íŠ¸ë¥¼ ì¤€ë‹¤ê³ ?"\n\nê´‘ê³ ë¥¼ ì‹œì²­í•˜ê³  <b>5,000P</b>ë¥¼ ë°›ì•˜ë‹¤!',
    btn:null,
    action:'jieun-ad',
    setup(){
      say('jieun','ê´‘ê³  í•œë²ˆ ë³¼ê¹Œ?');
      moveTo('jieun','bld-ad');
      // ê´‘ê³  ë³´ìƒ 5,000P ì§€ê¸‰
      setTimeout(()=>{
        STATE.chars.jieun.pts += 5000;
        STATE.chars.jieun.earned += 5000;
        STATE.totalEarned += 5000;
        STATE.pool += 1500;
        spawnFloat('jieun', '+5,000P ê´‘ê³ ë³´ìƒ!', 'bonus');
        spawnParticles('jieun');
        updateStats();
      }, 1200);
    }
  },
  // Step 6: ì´ì§€ì€ ì•½êµ­ ê²°ì œ
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'ì´ì§€ì€ì€ ë°›ì€ í¬ì¸íŠ¸ë¡œ ìš©ê¸°ë¥¼ ë‚´ì–´ <em>ì•½êµ­</em>ì—ì„œ ë¹„íƒ€ë¯¼ì„ êµ¬ë§¤í•œë‹¤.\n\n"ê´‘ê³  ë´ì„œ ë°›ì€ í¬ì¸íŠ¸ê°€ ìˆìœ¼ë‹ˆê¹Œ ë¶€ë‹´ì—†ë„¤!"',
    btn:null,
    action:'jieun-pharm',
    setup(){ say('jieun','ë¹„íƒ€ë¯¼ ì‚¬ëŸ¬ ê°€ì!'); moveTo('jieun','bld-pharm'); }
  },
  // Step 7: ì´ì§€ì€ ì•½êµ­ ê²°ì œ ê²°ê³¼
  {
    speaker:'ë¹„ì„ í˜•ê³µì‹ ì—”ì§„',
    text:null,
    btn:null,
    action:'pay',
    pay:{ who:'jieun', store:'ê±´ê°• ì•½êµ­', storeIcon:'ğŸ’Š', storeOwner:null,
          amount:8000, item:'ë¹„íƒ€ë¯¼ + ë§ˆìŠ¤í¬', bldId:'bld-pharm' }
  },
  // Step 8: ì˜í¬ ì£¼ìœ ì†Œ
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'ë‹¤ì‹œ <em>ì˜í¬</em>.\nì£¼ìœ  ê²½ê³ ë“±ì´ ì¼œì¡Œë‹¤.\n\n"ê¸°ë¦„ê°’ 7ë§Œì›ì´ë‚˜ í•˜ëŠ”ë°... ë‹¤ëœë“œë¡œ ê²°ì œí•˜ë©´ 120% ëŒì•„ì˜¨ë‹¤ëŠ” ê±°ì–ì•„!"',
    btn:null,
    action:'younghee-gas',
    setup(){ say('younghee','ì£¼ìœ í•˜ëŸ¬ ê°€ì!'); moveTo('younghee','bld-gas'); }
  },
  // Step 9: ì˜í¬ ì£¼ìœ  ê²°ì œ
  {
    speaker:'ë¹„ì„ í˜•ê³µì‹ ì—”ì§„',
    text:null,
    btn:null,
    action:'pay',
    pay:{ who:'younghee', store:'ì£¼ìœ ì†Œ', storeIcon:'â›½', storeOwner:null,
          amount:70000, item:'íœ˜ë°œìœ  ê°€ë“ ì£¼ìœ ', bldId:'bld-gas' }
  },
  // Step 10: ì˜í¬ ì‹ë‹¹
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'ì €ë…, <em>ì˜í¬</em>ëŠ” ê°€ì¡±ê³¼ ì™¸ì‹ì„ ë‚˜ì™”ë‹¤.\n\n"ì˜¤ëŠ˜ í•˜ë£¨ ì¢…ì¼ ë‹¤ëœë“œë¡œ ê²°ì œí–ˆë”ë‹ˆ í¬ì¸íŠ¸ê°€ ìŒ“ì´ë„¤!\nê°€ì¡± ì™¸ì‹ë„ ë‹¤ëœë“œë¡œ í•˜ì."',
    btn:null,
    action:'younghee-rest',
    setup(){ say('younghee','ê°€ì¡± ì™¸ì‹!'); moveTo('younghee','bld-rest'); }
  },
  // Step 11: ì˜í¬ ì‹ë‹¹ ê²°ì œ
  {
    speaker:'ë¹„ì„ í˜•ê³µì‹ ì—”ì§„',
    text:null,
    btn:null,
    action:'pay',
    pay:{ who:'younghee', store:'ë§›ìˆëŠ” ì‹ë‹¹', storeIcon:'ğŸ½ï¸', storeOwner:null,
          amount:25000, item:'ê¹€ì¹˜ì°Œê°œ 4ì¸ë¶„', bldId:'bld-rest' }
  },
  // Step 12: ìƒíƒœê³„ ë³´ê¸°
  {
    speaker:'ë‚´ë ˆì´í„°',
    text:'í•˜ë£¨ê°€ ëë‚¬ìŠµë‹ˆë‹¤.\n\nì„¸ ì‚¬ëŒ ëª¨ë‘ê°€ ì†Œë¹„ë¥¼ í–ˆê³ ,\n<em>ëª¨ë“  ì†Œë¹„ì—ì„œ 120%ê°€ ëŒì•„ì™”ìŠµë‹ˆë‹¤.</em>\n\ní•œ ì‚¬ëŒì˜ ì†Œë¹„ê°€ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì˜í–¥ì„ ì£¼ê³ ,\nê·¸ ì‚¬ëŒì˜ ì†Œë¹„ê°€ ë‹¤ì‹œ ìˆœí™˜í•˜ëŠ”\n<em>ì„ ìˆœí™˜ ê²½ì œ</em>ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
    btn:'ìƒíƒœê³„ í•œëˆˆì— ë³´ê¸° â†’',
    action:'ending',
    setup(){ say('younghee','ëŒ€ë°•ì´ì•¼!'); say('chulsu','ì†ë‹˜ì´ ëŠ˜ì—ˆì–´!'); say('jieun','ë‚˜ë„ í•´ë³¼ë˜!'); }
  },
];

/* ===== ì¸íŠ¸ë¡œ â†’ ê²Œì„ ===== */
function startGame(){
  document.getElementById('intro').classList.add('hide');
  setTimeout(()=>{
    document.getElementById('main').classList.add('on');
    runStep(0);
  }, 600);
}

/* ===== ìŠ¤í… ì‹¤í–‰ ===== */
function runStep(idx){
  if(idx >= SCENARIO.length) return;
  STATE.step = idx;
  const s = SCENARIO[idx];

  // speaker & text
  if(s.speaker) document.getElementById('storySpeaker').textContent = s.speaker;
  if(s.text) document.getElementById('storyText').innerHTML = s.text.replace(/\n/g,'<br>');

  // setup
  if(s.setup) s.setup();

  // button
  const btn = document.getElementById('storyBtn');
  if(s.btn){
    btn.textContent = s.btn;
    btn.style.display = 'block';
    btn.disabled = false;
  } else {
    btn.style.display = 'none';
  }

  // action
  if(s.action === 'pay'){
    setTimeout(()=> showPayResult(s.pay), 1400);
  } else if(s.action && s.action !== 'ending'){
    // movement step - auto advance after character arrives
    setTimeout(()=> {
      const nextIdx = idx + 1;
      if(nextIdx < SCENARIO.length) runStep(nextIdx);
    }, 1800);
  }
}

function nextStep(){
  const s = SCENARIO[STATE.step];
  if(s.action === 'ending'){
    showEcosystem();
    return;
  }
  runStep(STATE.step + 1);
}

/* ===== ìºë¦­í„° ì´ë™ ===== */
function moveTo(charId, bldId){
  const charEl = document.getElementById('char-' + charId);
  const bldEl = document.getElementById(bldId);
  if(!charEl || !bldEl) return;

  charEl.classList.add('walking');
  const bldRect = bldEl.getBoundingClientRect();
  const mapRect = document.getElementById('townMap').getBoundingClientRect();

  // ê±´ë¬¼ ì•„ë˜ìª½ìœ¼ë¡œ ì´ë™
  const targetLeft = ((bldRect.left - mapRect.left + bldRect.width/2 - 18) / mapRect.width * 100);
  const targetTop = ((bldRect.top - mapRect.top + bldRect.height + 5) / mapRect.height * 100);

  charEl.style.left = targetLeft + '%';
  charEl.style.top = Math.min(targetTop, 88) + '%';

  setTimeout(()=> charEl.classList.remove('walking'), 1200);
}

/* ===== ë§í’ì„  ===== */
function say(charId, text){
  const el = document.getElementById('speech-' + charId);
  if(!el) return;
  el.textContent = text;
  el.classList.add('on');
}
function clearSpeech(){
  document.querySelectorAll('.speech').forEach(el => el.classList.remove('on'));
}

/* ===== ê²°ì œ ê²°ê³¼ ëª¨ë‹¬ ===== */
function showPayResult(pay){
  const earned = Math.round(pay.amount * 1.2);
  const bonus = earned - pay.amount;
  const sellerShare = Math.round(pay.amount * 0.5);
  const consumerShare = Math.round(pay.amount * 0.5);

  // ìƒíƒœ ì—…ë°ì´íŠ¸
  const c = STATE.chars[pay.who];
  c.pts += earned;
  c.spent += pay.amount;
  c.earned += earned;
  STATE.totalSpent += pay.amount;
  STATE.totalEarned += earned;

  // íŒë§¤ì ë³´ë„ˆìŠ¤
  let ownerBonus = sellerShare;
  if(pay.storeOwner){
    STATE.chars[pay.storeOwner].pts += ownerBonus;
    STATE.chars[pay.storeOwner].earned += ownerBonus;
  }
  STATE.pool += Math.round(pay.amount * 0.3);

  // ê±´ë¬¼ visited ì²˜ë¦¬
  const bldEl = document.getElementById(pay.bldId);
  if(bldEl) bldEl.classList.add('visited');

  // í”Œë¡œíŒ… í…ìŠ¤íŠ¸ on map
  spawnFloat(pay.who, `-${pay.amount.toLocaleString()}ì›`, 'negative');
  setTimeout(()=> spawnFloat(pay.who, `+${earned.toLocaleString()}P`, 'positive'), 800);
  if(pay.storeOwner){
    setTimeout(()=> spawnFloat(pay.storeOwner, `+${ownerBonus.toLocaleString()}P`, 'bonus'), 1200);
  }

  // íŒŒí‹°í´
  setTimeout(()=> spawnParticles(pay.who), 800);

  // ëª¨ë‹¬
  setTimeout(()=>{
    const card = document.getElementById('resultCard');
    card.innerHTML = buildResultHTML(pay, earned, bonus, sellerShare, consumerShare, ownerBonus);
    document.getElementById('resultModal').classList.add('on');

    // ë‹¨ê³„ë³„ ì• ë‹ˆë©”ì´ì…˜
    let delay = 200;
    card.querySelectorAll('.formula-step').forEach(el => {
      setTimeout(()=> el.classList.add('show'), delay);
      delay += 400;
    });
    setTimeout(()=>{
      const big = card.querySelector('.rc-big');
      if(big) big.classList.add('show');
    }, delay);
    setTimeout(()=>{
      const badge = card.querySelector('.rc-badge');
      if(badge) badge.classList.add('show');
    }, delay + 300);
    let chainDelay = delay + 600;
    card.querySelectorAll('.chain-card').forEach(el => {
      setTimeout(()=> el.classList.add('show'), chainDelay);
      chainDelay += 300;
    });
    setTimeout(()=>{
      const btn = card.querySelector('.rc-btn');
      if(btn) btn.style.opacity = '1';
    }, chainDelay + 200);

  }, 1600);
}

function buildResultHTML(pay, earned, bonus, sellerShare, consumerShare, ownerBonus){
  const charInfo = STATE.chars[pay.who];
  let ownerSection = '';
  if(pay.storeOwner){
    const ownerInfo = STATE.chars[pay.storeOwner];
    ownerSection = `
      <div class="chain-card">
        <div class="cci">${ownerInfo.emoji}</div>
        <div class="cctext"><b>${ownerInfo.name}</b> (íŒë§¤ì)<br><span class="sub">íŒë§¤ì ì ë¦½ 50%</span></div>
        <div class="ccpts">+${ownerBonus.toLocaleString()}P</div>
      </div>`;
  }

  return `
    <div class="rc-icon">${pay.storeIcon}</div>
    <div class="rc-title">${pay.store}</div>
    <div class="rc-subtitle">${charInfo.emoji} ${charInfo.name} Â· ${pay.item}</div>

    <div class="formula-step">
      <div class="fs-label">ê²°ì œ ê¸ˆì•¡</div>
      <div class="fs-value"><span class="hl-red">-${pay.amount.toLocaleString()}ì›</span></div>
    </div>

    <div class="formula-step">
      <div class="fs-label">A1: íŒë§¤ì ì ë¦½ (50%)</div>
      <div class="fs-value">${pay.amount.toLocaleString()} Ã— 50% = <span class="hl-yellow">${sellerShare.toLocaleString()}P</span></div>
    </div>

    <div class="formula-step">
      <div class="fs-label">B1: ì†Œë¹„ì ì ë¦½ (50%)</div>
      <div class="fs-value">${pay.amount.toLocaleString()} Ã— 50% = <span class="hl-yellow">${consumerShare.toLocaleString()}P</span></div>
    </div>

    <div class="formula-step">
      <div class="fs-label">U: ë©¤ë²„ì‹­ í’€ Ã— 10ë°° í™•ì¥ + ë³´ì •ëª¨ë“œ</div>
      <div class="fs-value">150% â†’ <span class="hl">120%</span> ì•ˆì „ë³´ì • ì™„ë£Œ</div>
    </div>

    <div class="rc-big">+${earned.toLocaleString()}P</div>
    <div class="rc-badge">120% ì ë¦½!</div>

    <div style="margin-top:8px;font-size:0.75rem;color:#888;">
      ì›ê¸ˆ ${pay.amount.toLocaleString()}P + ë³´ë„ˆìŠ¤ ${bonus.toLocaleString()}P
    </div>

    <div style="margin:12px 0 4px;font-size:0.7rem;color:#7b2ff7;font-weight:700;">
      â”€â”€ ì—°ì‡„íš¨ê³¼ â”€â”€
    </div>

    <div class="chain-cards">
      <div class="chain-card">
        <div class="cci">${charInfo.emoji}</div>
        <div class="cctext"><b>${charInfo.name}</b> (ì†Œë¹„ì)<br><span class="sub">ì´ ì ë¦½: ${charInfo.pts.toLocaleString()}P</span></div>
        <div class="ccpts">+${earned.toLocaleString()}P</div>
      </div>
      ${ownerSection}
      <div class="chain-card">
        <div class="cci">ğŸ¦</div>
        <div class="cctext"><b>ë©¤ë²„ì‹­ í’€</b><br><span class="sub">ëª¨ë“  íšŒì›ì˜ ì†Œë¹„ê°€ í’€ì„ í‚¤ì›ë‹ˆë‹¤</span></div>
        <div class="ccpts">${STATE.pool.toLocaleString()}P</div>
      </div>
    </div>

    <button class="rc-btn" style="opacity:0;transition:opacity 0.5s;" onclick="closeResult()">
      ë‹¤ìŒ â†’
    </button>
  `;
}

function closeResult(){
  document.getElementById('resultModal').classList.remove('on');
  updateStats();
  // ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ
  const nextIdx = STATE.step + 1;
  if(nextIdx < SCENARIO.length){
    runStep(nextIdx);
  }
}

/* ===== í”Œë¡œíŒ… í…ìŠ¤íŠ¸ ===== */
function spawnFloat(charId, text, type){
  const charEl = document.getElementById('char-' + charId);
  const mapEl = document.getElementById('townMap');
  if(!charEl || !mapEl) return;

  const rect = charEl.getBoundingClientRect();
  const mapRect = mapEl.getBoundingClientRect();

  const el = document.createElement('div');
  el.className = 'float-text ' + type;
  el.textContent = text;
  el.style.left = (rect.left - mapRect.left + rect.width/2) + 'px';
  el.style.top = (rect.top - mapRect.top - 10) + 'px';
  el.style.transform = 'translateX(-50%)';
  mapEl.appendChild(el);
  setTimeout(()=> el.remove(), 4000);
}

/* ===== íŒŒí‹°í´ ===== */
function spawnParticles(charId){
  const charEl = document.getElementById('char-' + charId);
  const mapEl = document.getElementById('townMap');
  if(!charEl || !mapEl) return;

  const rect = charEl.getBoundingClientRect();
  const mapRect = mapEl.getBoundingClientRect();
  const cx = rect.left - mapRect.left + rect.width/2;
  const cy = rect.top - mapRect.top;

  const emojis = ['ğŸ’°','âœ¨','ğŸ‰','ğŸ’','â­','ğŸª™'];
  for(let i=0; i<8; i++){
    setTimeout(()=>{
      const p = document.createElement('div');
      p.className = 'particle';
      p.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      p.style.left = cx + 'px';
      p.style.top = cy + 'px';
      p.style.setProperty('--dx', (Math.random()*80-40)+'px');
      p.style.setProperty('--dy', (-30-Math.random()*50)+'px');
      mapEl.appendChild(p);
      setTimeout(()=> p.remove(), 1500);
    }, i*60);
  }
}

/* ===== ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ ===== */
function updateStats(){
  for(const [key, c] of Object.entries(STATE.chars)){
    document.getElementById('sp-' + key).textContent = c.pts.toLocaleString() + 'P';
  }
  document.getElementById('poolAmount').textContent = STATE.pool.toLocaleString() + 'P';
}

/* ===== ìƒíƒœê³„ ì—”ë”© ===== */
function showEcosystem(){
  const ov = document.getElementById('ecoOverlay');

  // ìºë¦­í„° í¬ì¸íŠ¸
  document.getElementById('cn-pts-y').textContent = STATE.chars.younghee.pts.toLocaleString() + 'P';
  document.getElementById('cn-pts-c').textContent = STATE.chars.chulsu.pts.toLocaleString() + 'P';
  document.getElementById('cn-pts-j').textContent = STATE.chars.jieun.pts.toLocaleString() + 'P';

  // í†µê³„
  const totalProfit = STATE.totalEarned - STATE.totalSpent;
  document.getElementById('ecoStats').innerHTML = `
    <div class="eco-stat"><div class="es-label">ì´ ì†Œë¹„ ê¸ˆì•¡</div><div class="es-val c1">${STATE.totalSpent.toLocaleString()}ì›</div></div>
    <div class="eco-stat"><div class="es-label">ì´ ì ë¦½ í¬ì¸íŠ¸</div><div class="es-val c2">${STATE.totalEarned.toLocaleString()}P</div></div>
    <div class="eco-stat"><div class="es-label">ìˆœì´ìµ (ì ë¦½ - ì†Œë¹„)</div><div class="es-val c3">+${totalProfit.toLocaleString()}P</div></div>
    <div class="eco-stat"><div class="es-label">í‰ê·  ì ë¦½ë¥ </div><div class="es-val c4">120%</div></div>
  `;

  ov.classList.add('on');
}
</script>
</body>
</html>
